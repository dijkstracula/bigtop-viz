import React, { Component, useEffect } from 'react';

import { Result } from "./interfaces"
import { KeyframeTable } from './components/KeyframeTable'
import { Keyframe, KeyframesFromLines } from './keyframe';
import { PlaybackControls } from './components/PlaybackControls';


const INPUT = `new state,previous state,action,reward
[0.011347046974051981 -0.15130313186528035 0.016331433696223002 0.2916006514062464],[0.010466028797961956 0.04405090880450124 0.016456005321849043 -0.006228581281301979],0,0.000000
[0.008320984336746374 -0.34665409126457547 0.022163446724347932 0.5893892420667983],[0.011347046974051981 -0.15130313186528035 0.016331433696223002 0.2916006514062464],0,0.000000
[0.0013879025114548645 -0.5420792609518238 0.0339512315656839 0.8889705221022804],[0.008320984336746374 -0.34665409126457547 0.022163446724347932 0.5893892420667983],0,0.000000
[-0.009453682707581611 -0.7376450890245887 0.05173064200772951 1.1921299555090266],[0.0013879025114548645 -0.5420792609518238 0.0339512315656839 0.8889705221022804],0,0.000000
[-0.024206584488073384 -0.9333976214028855 0.07557324111791004 1.5005679840206194],[-0.009453682707581611 -0.7376450890245887 0.05173064200772951 1.1921299555090266],0,0.000000
[-0.04287453691613109 -1.1293516876858987 0.10558460079832244 1.815857505765986],[-0.024206584488073384 -0.9333976214028855 0.07557324111791004 1.5005679840206194],0,0.000000
[-0.06546157066984906 -1.3254782319400435 0.14190175091364216 2.1393932435036724],[-0.04287453691613109 -1.1293516876858987 0.10558460079832244 1.815857505765986],0,0.000000
[-0.09197113530864993 -1.5216893762251393 0.18468961578371562 2.472330978002499],[-0.06546157066984906 -1.3254782319400435 0.14190175091364216 2.1393932435036724],0,0.000000
[-0.007536250292873428 0.018682307286710942 -0.04343629807825238 -0.03434807452672088],[-0.09197113530864993 -1.5216893762251393 0.18468961578371562 2.472330978002499],0,-1.000000
[-0.007162604147139209 -0.17579070654939938 -0.0441232595687868 0.24432004718942507],[-0.007536250292873428 0.018682307286710942 -0.04343629807825238 -0.03434807452672088],0,0.000000
[-0.010678418278127197 0.01993278367985471 -0.0392368586249983 -0.06194747907230719],[-0.007162604147139209 -0.17579070654939938 -0.0441232595687868 0.24432004718942507],1,0.000000
[-0.010279762604530103 0.21559469491025948 -0.04047580820644445 -0.36674713095818173],[-0.010678418278127197 0.01993278367985471 -0.0392368586249983 -0.06194747907230719],1,0.000000
[-0.005967868706324913 0.411267741267505 -0.04781075082560808 -0.6719129448982395],[-0.010279762604530103 0.21559469491025948 -0.04047580820644445 -0.36674713095818173],1,0.000000
[0.002257486119025187 0.607020557289353 -0.061249009723572875 -0.9792576402367656],[-0.005967868706324913 0.411267741267505 -0.04781075082560808 -0.6719129448982395],1,0.000000
[0.014397897264812247 0.8029077446633469 -0.08083416252830819 -1.2905334012667913],[0.002257486119025187 0.607020557289353 -0.061249009723572875 -0.9792576402367656],1,0.000000
[0.030456052158079186 0.9989592018385722 -0.10664483055364402 -1.6073897073547516],[0.014397897264812247 0.8029077446633469 -0.08083416252830819 -1.2905334012667913],1,0.000000
[0.05043523619485063 1.1951680543480558 -0.13879262470073905 -1.9313251242479277],[0.030456052158079186 0.9989592018385722 -0.10664483055364402 -1.6073897073547516],1,0.000000
[0.07433859728181175 1.3914766507859357 -0.1774191271856976 -2.2636305422267693],[0.05043523619485063 1.1951680543480558 -0.13879262470073905 -1.9313251242479277],1,0.000000
[-0.040303048108551544 -0.019908813941471294 0.0015212628502065395 0.03136399609900968],[0.07433859728181175 1.3914766507859357 -0.1774191271856976 -2.2636305422267693],1,-1.000000
[-0.04070122438738097 0.17519128859896915 0.002148542772186733 -0.260838567974821],[-0.040303048108551544 -0.019908813941471294 0.0015212628502065395 0.03136399609900968],1,0.000000
[-0.03719739861540158 0.3702825033836442 -0.0030682285873096875 -0.5528430436227381],[-0.04070122438738097 0.17519128859896915 0.002148542772186733 -0.260838567974821],1,0.000000
[-0.0297917485477287 0.5654474078940182 -0.014125089459764449 -0.8464910802130037],[-0.03719739861540158 0.3702825033836442 -0.0030682285873096875 -0.5528430436227381],1,0.000000
[-0.018482800389848335 0.7607591813747211 -0.031054911064024523 -1.1435821529470394],[-0.0297917485477287 0.5654474078940182 -0.014125089459764449 -0.8464910802130037],1,0.000000
[-0.003267616762353912 0.9562728108475114 -0.053926554122965306 -1.4458398688066687],[-0.018482800389848335 0.7607591813747211 -0.031054911064024523 -1.1435821529470394],1,0.000000
[0.015857839454596317 0.7618541481911734 -0.08284335149909869 -1.1704825335869748],[-0.003267616762353912 0.9562728108475114 -0.053926554122965306 -1.4458398688066687],0,0.000000
[0.031094922418419785 0.5679014354667151 -0.10625300217083819 -0.9048793154809306],[0.015857839454596317 0.7618541481911734 -0.08284335149909869 -1.1704825335869748],0,0.000000
[0.04245295112775409 0.3743664194035522 -0.1243505884804568 -0.6473936016666736],[0.031094922418419785 0.5679014354667151 -0.10625300217083819 -0.9048793154809306],0,0.000000
[0.04994027951582513 0.18117625412670993 -0.13729846051379027 -0.39631087938449056],[0.04245295112775409 0.3743664194035522 -0.1243505884804568 -0.6473936016666736],0,0.000000
[0.05356380459835933 0.3779519235216166 -0.14522467810148007 -0.7289357523570109],[0.04994027951582513 0.18117625412670993 -0.13729846051379027 -0.39631087938449056],1,0.000000
[0.06112284306879166 0.18510404196625072 -0.1598033931486203 -0.4852551094161426],[0.05356380459835933 0.3779519235216166 -0.14522467810148007 -0.7289357523570109],0,0.000000
[0.06482492390811667 0.3820774971606905 -0.16950849533694315 -0.8237331998152999],[0.06112284306879166 0.18510404196625072 -0.1598033931486203 -0.4852551094161426],1,0.000000
[0.07246647385133048 0.18962931739832758 -0.18598315933324916 -0.5887954236509622],[0.06482492390811667 0.3820774971606905 -0.16950849533694315 -0.8237331998152999],0,0.000000
[0.07625906019929704 -0.0024683769591866134 -0.1977590678062684 -0.3599823615616279],[0.07246647385133048 0.18962931739832758 -0.18598315933324916 -0.5887954236509622],0,0.000000
[0.0762096926601133 0.1948342392930682 -0.20495871503750096 -0.7079308789288125],[0.07625906019929704 -0.0024683769591866134 -0.1977590678062684 -0.3599823615616279],1,0.000000
[-0.02857361274176251 -0.011934281070031402 -0.018194182566967018 -0.003111015509757682],[0.0762096926601133 0.1948342392930682 -0.20495871503750096 -0.7079308789288125],1,-1.000000
[-0.02881229836316314 0.18344381175718966 -0.01825640287716217 -0.301478443896173],[-0.02857361274176251 -0.011934281070031402 -0.018194182566967018 -0.003111015509757682],1,0.000000
[-0.025143422128019344 0.37882114534682043 -0.02428597175508563 -0.5998626910343259],[-0.02881229836316314 0.18344381175718966 -0.01825640287716217 -0.301478443896173],1,0.000000
[-0.017566999221082936 0.5742742975827557 -0.03628322557577215 -0.9000953375381623],[-0.025143422128019344 0.37882114534682043 -0.02428597175508563 -0.5998626910343259],1,0.000000
[-0.006081513269427822 0.37966231017987784 -0.054285132326535396 -0.6190344142915758],[-0.017566999221082936 0.5742742975827557 -0.03628322557577215 -0.9000953375381623],0,0.000000
[0.0015117329341697346 0.18533893354050945 -0.06666582061236691 -0.3439307204384372],[-0.006081513269427822 0.37966231017987784 -0.054285132326535396 -0.6190344142915758],0,0.000000
[0.005218511604979924 0.38134280706619017 -0.07354443502113565 -0.6568686795167806],[0.0015117329341697346 0.18533893354050945 -0.06666582061236691 -0.3439307204384372],1,0.000000
[0.012845367746303727 0.187317510751895 -0.08668180861147126 -0.3882200386791835],[0.005218511604979924 0.38134280706619017 -0.07354443502113565 -0.6568686795167806],0,0.000000
[0.016591717961341627 -0.006473966694430067 -0.09444620938505494 -0.12407676218969577],[0.012845367746303727 0.187317510751895 -0.08668180861147126 -0.3882200386791835],0,0.000000
[0.016462238627453024 0.18986525656591804 -0.09692774462884884 -0.4449989740653315],[0.016591717961341627 -0.006473966694430067 -0.09444620938505494 -0.12407676218969577],1,0.000000
[0.020259543758771384 -0.0037613057787580784 -0.10582772411015548 -0.18437455885935522],[0.016462238627453024 0.18986525656591804 -0.09692774462884884 -0.4449989740653315],0,0.000000
[0.020184317643196222 0.19270316236456117 -0.10951521528734258 -0.5084778794288376],[0.020259543758771384 -0.0037613057787580784 -0.10582772411015548 -0.18437455885935522],1,0.000000
[0.024038380890487446 -0.0007192118672975367 -0.11968477287591933 -0.25221560159178796],[0.020184317643196222 0.19270316236456117 -0.10951521528734258 -0.5084778794288376],0,0.000000
[0.024023996653141495 -0.193946900394071 -0.1247290849077551 0.00044912161560128894],[0.024038380890487446 -0.0007192118672975367 -0.11968477287591933 -0.25221560159178796],0,0.000000
[0.020145058645260075 0.0027226347461993816 -0.12472010247544307 -0.32883875544104135],[0.024023996653141495 -0.193946900394071 -0.1247290849077551 0.00044912161560128894],1,0.000000`.split("\n")

type AppState = {
  keyframes: Result<Keyframe[]>
  currentFrame: number
  isPlaying: boolean
  fps: number
}

export default class App extends Component<{}, AppState> {
  public state: AppState = {
    keyframes: KeyframesFromLines(INPUT),
    currentFrame: 0,
    isPlaying: true,
    fps: 15
  }

  onTimeout() {
    setTimeout(() => {
      if (this.state.isPlaying && !(this.state.keyframes instanceof Error)) {
        this.setState({ currentFrame: (this.state.currentFrame + 1) % (this.state.keyframes.length - 1) })
        this.onTimeout()
      }
    }, 1000 / this.state.fps)
  }

  componentDidMount() {
    this.onTimeout()
  }

  render() {
    let kfComponent;
    if (this.state.keyframes instanceof Error) {
      kfComponent = (<div>Error: {this.state.keyframes} </div>)
    } else {
      kfComponent = (<KeyframeTable currentFrame={this.state.currentFrame} keyframes={this.state.keyframes} />)
    }
    return (
      /* Menu */
      <div className="container flex-direction=row">
        <div className="terminal-nav">
          <header className="terminal-logo">Bigtop</header>
          <nav className="terminal-menu">
            <ul vocab="https://schema.org" typeof="BreadcrumbList">
              <li><a href="#">About</a></li>
              <li><a href="#">Upload</a></li>
            </ul>
          </nav>
        </div>
        <hr />
        <div className="flex flex-direction=column">
          {/* left column: the viz stage */}
          <div className="stage">
            <header>
              <h2>Vis</h2>
            </header>
            <div className="state"></div>
          </div>
          {/* right column: the keyframe table and controls */}
          <div className="flex-direction=row">
            <div className="keyframe-table">
              <header>
                <h3>Keyframes</h3>
              </header>
              {kfComponent}
            </div>
            <div className="keyframe-table">
              <PlaybackControls
                isPlaying={this.state.isPlaying}
                fps={this.state.fps}
                currentFrame={this.state.currentFrame}
                totalFrames={48}
                onFPSChange={(fps: number) => this.setState({ fps: fps })}
                onFrameChange={(frame: number) => {
                  this.setState({ currentFrame: frame, isPlaying: false })
                }}
                onPauseClick={() => {
                  this.setState({ isPlaying: !this.state.isPlaying })
                  this.onTimeout()
                }} />
            </div>
          </div>
        </div>
      </div >
    );
  }
};
