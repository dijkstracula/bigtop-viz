import React, { Component, useEffect } from 'react';

import { Result } from "./interfaces"
import { KeyframeTable } from './components/KeyframeTable'
import { Keyframe, KeyframesFromLines } from './keyframe';
import { PlaybackControls } from './components/PlaybackControls';
import { CartpoleStage } from './components/CartpoleStage';

const INPUT = `new state,previous state,action,reward
[0.011347046974051981 -0.15130313186528035 0.016331433696223002 0.2916006514062464],[0.010466028797961956 0.04405090880450124 0.016456005321849043 -0.006228581281301979],0,0.000000
[0.008320984336746374 -0.34665409126457547 0.022163446724347932 0.5893892420667983],[0.011347046974051981 -0.15130313186528035 0.016331433696223002 0.2916006514062464],0,0.000000
[0.0013879025114548645 -0.5420792609518238 0.0339512315656839 0.8889705221022804],[0.008320984336746374 -0.34665409126457547 0.022163446724347932 0.5893892420667983],0,0.000000
[-0.009453682707581611 -0.7376450890245887 0.05173064200772951 1.1921299555090266],[0.0013879025114548645 -0.5420792609518238 0.0339512315656839 0.8889705221022804],0,0.000000
[-0.024206584488073384 -0.9333976214028855 0.07557324111791004 1.5005679840206194],[-0.009453682707581611 -0.7376450890245887 0.05173064200772951 1.1921299555090266],0,0.000000
[-0.04287453691613109 -1.1293516876858987 0.10558460079832244 1.815857505765986],[-0.024206584488073384 -0.9333976214028855 0.07557324111791004 1.5005679840206194],0,0.000000
[-0.06546157066984906 -1.3254782319400435 0.14190175091364216 2.1393932435036724],[-0.04287453691613109 -1.1293516876858987 0.10558460079832244 1.815857505765986],0,0.000000
[-0.09197113530864993 -1.5216893762251393 0.18468961578371562 2.472330978002499],[-0.06546157066984906 -1.3254782319400435 0.14190175091364216 2.1393932435036724],0,0.000000
[-0.007536250292873428 0.018682307286710942 -0.04343629807825238 -0.03434807452672088],[-0.09197113530864993 -1.5216893762251393 0.18468961578371562 2.472330978002499],0,-1.000000
[-0.007162604147139209 -0.17579070654939938 -0.0441232595687868 0.24432004718942507],[-0.007536250292873428 0.018682307286710942 -0.04343629807825238 -0.03434807452672088],0,0.000000
[-0.010678418278127197 0.01993278367985471 -0.0392368586249983 -0.06194747907230719],[-0.007162604147139209 -0.17579070654939938 -0.0441232595687868 0.24432004718942507],1,0.000000
[-0.010279762604530103 0.21559469491025948 -0.04047580820644445 -0.36674713095818173],[-0.010678418278127197 0.01993278367985471 -0.0392368586249983 -0.06194747907230719],1,0.000000
[-0.005967868706324913 0.411267741267505 -0.04781075082560808 -0.6719129448982395],[-0.010279762604530103 0.21559469491025948 -0.04047580820644445 -0.36674713095818173],1,0.000000
[0.002257486119025187 0.607020557289353 -0.061249009723572875 -0.9792576402367656],[-0.005967868706324913 0.411267741267505 -0.04781075082560808 -0.6719129448982395],1,0.000000
[0.014397897264812247 0.8029077446633469 -0.08083416252830819 -1.2905334012667913],[0.002257486119025187 0.607020557289353 -0.061249009723572875 -0.9792576402367656],1,0.000000
[0.030456052158079186 0.9989592018385722 -0.10664483055364402 -1.6073897073547516],[0.014397897264812247 0.8029077446633469 -0.08083416252830819 -1.2905334012667913],1,0.000000
[0.05043523619485063 1.1951680543480558 -0.13879262470073905 -1.9313251242479277],[0.030456052158079186 0.9989592018385722 -0.10664483055364402 -1.6073897073547516],1,0.000000
[0.07433859728181175 1.3914766507859357 -0.1774191271856976 -2.2636305422267693],[0.05043523619485063 1.1951680543480558 -0.13879262470073905 -1.9313251242479277],1,0.000000
[-0.040303048108551544 -0.019908813941471294 0.0015212628502065395 0.03136399609900968],[0.07433859728181175 1.3914766507859357 -0.1774191271856976 -2.2636305422267693],1,-1.000000
[-0.04070122438738097 0.17519128859896915 0.002148542772186733 -0.260838567974821],[-0.040303048108551544 -0.019908813941471294 0.0015212628502065395 0.03136399609900968],1,0.000000
[-0.03719739861540158 0.3702825033836442 -0.0030682285873096875 -0.5528430436227381],[-0.04070122438738097 0.17519128859896915 0.002148542772186733 -0.260838567974821],1,0.000000
[-0.0297917485477287 0.5654474078940182 -0.014125089459764449 -0.8464910802130037],[-0.03719739861540158 0.3702825033836442 -0.0030682285873096875 -0.5528430436227381],1,0.000000
[-0.018482800389848335 0.7607591813747211 -0.031054911064024523 -1.1435821529470394],[-0.0297917485477287 0.5654474078940182 -0.014125089459764449 -0.8464910802130037],1,0.000000
[-0.003267616762353912 0.9562728108475114 -0.053926554122965306 -1.4458398688066687],[-0.018482800389848335 0.7607591813747211 -0.031054911064024523 -1.1435821529470394],1,0.000000
[0.015857839454596317 0.7618541481911734 -0.08284335149909869 -1.1704825335869748],[-0.003267616762353912 0.9562728108475114 -0.053926554122965306 -1.4458398688066687],0,0.000000
[0.031094922418419785 0.5679014354667151 -0.10625300217083819 -0.9048793154809306],[0.015857839454596317 0.7618541481911734 -0.08284335149909869 -1.1704825335869748],0,0.000000
[0.04245295112775409 0.3743664194035522 -0.1243505884804568 -0.6473936016666736],[0.031094922418419785 0.5679014354667151 -0.10625300217083819 -0.9048793154809306],0,0.000000
[0.04994027951582513 0.18117625412670993 -0.13729846051379027 -0.39631087938449056],[0.04245295112775409 0.3743664194035522 -0.1243505884804568 -0.6473936016666736],0,0.000000
[0.05356380459835933 0.3779519235216166 -0.14522467810148007 -0.7289357523570109],[0.04994027951582513 0.18117625412670993 -0.13729846051379027 -0.39631087938449056],1,0.000000
[0.06112284306879166 0.18510404196625072 -0.1598033931486203 -0.4852551094161426],[0.05356380459835933 0.3779519235216166 -0.14522467810148007 -0.7289357523570109],0,0.000000
[0.06482492390811667 0.3820774971606905 -0.16950849533694315 -0.8237331998152999],[0.06112284306879166 0.18510404196625072 -0.1598033931486203 -0.4852551094161426],1,0.000000
[0.07246647385133048 0.18962931739832758 -0.18598315933324916 -0.5887954236509622],[0.06482492390811667 0.3820774971606905 -0.16950849533694315 -0.8237331998152999],0,0.000000
[0.07625906019929704 -0.0024683769591866134 -0.1977590678062684 -0.3599823615616279],[0.07246647385133048 0.18962931739832758 -0.18598315933324916 -0.5887954236509622],0,0.000000
[0.0762096926601133 0.1948342392930682 -0.20495871503750096 -0.7079308789288125],[0.07625906019929704 -0.0024683769591866134 -0.1977590678062684 -0.3599823615616279],1,0.000000
[-0.02857361274176251 -0.011934281070031402 -0.018194182566967018 -0.003111015509757682],[0.0762096926601133 0.1948342392930682 -0.20495871503750096 -0.7079308789288125],1,-1.000000
[-0.02881229836316314 0.18344381175718966 -0.01825640287716217 -0.301478443896173],[-0.02857361274176251 -0.011934281070031402 -0.018194182566967018 -0.003111015509757682],1,0.000000
[-0.025143422128019344 0.37882114534682043 -0.02428597175508563 -0.5998626910343259],[-0.02881229836316314 0.18344381175718966 -0.01825640287716217 -0.301478443896173],1,0.000000
[-0.017566999221082936 0.5742742975827557 -0.03628322557577215 -0.9000953375381623],[-0.025143422128019344 0.37882114534682043 -0.02428597175508563 -0.5998626910343259],1,0.000000
[-0.006081513269427822 0.37966231017987784 -0.054285132326535396 -0.6190344142915758],[-0.017566999221082936 0.5742742975827557 -0.03628322557577215 -0.9000953375381623],0,0.000000
[0.0015117329341697346 0.18533893354050945 -0.06666582061236691 -0.3439307204384372],[-0.006081513269427822 0.37966231017987784 -0.054285132326535396 -0.6190344142915758],0,0.000000
[0.005218511604979924 0.38134280706619017 -0.07354443502113565 -0.6568686795167806],[0.0015117329341697346 0.18533893354050945 -0.06666582061236691 -0.3439307204384372],1,0.000000
[0.012845367746303727 0.187317510751895 -0.08668180861147126 -0.3882200386791835],[0.005218511604979924 0.38134280706619017 -0.07354443502113565 -0.6568686795167806],0,0.000000
[0.016591717961341627 -0.006473966694430067 -0.09444620938505494 -0.12407676218969577],[0.012845367746303727 0.187317510751895 -0.08668180861147126 -0.3882200386791835],0,0.000000
[0.016462238627453024 0.18986525656591804 -0.09692774462884884 -0.4449989740653315],[0.016591717961341627 -0.006473966694430067 -0.09444620938505494 -0.12407676218969577],1,0.000000
[0.020259543758771384 -0.0037613057787580784 -0.10582772411015548 -0.18437455885935522],[0.016462238627453024 0.18986525656591804 -0.09692774462884884 -0.4449989740653315],0,0.000000
[0.020184317643196222 0.19270316236456117 -0.10951521528734258 -0.5084778794288376],[0.020259543758771384 -0.0037613057787580784 -0.10582772411015548 -0.18437455885935522],1,0.000000
[0.024038380890487446 -0.0007192118672975367 -0.11968477287591933 -0.25221560159178796],[0.020184317643196222 0.19270316236456117 -0.10951521528734258 -0.5084778794288376],0,0.000000
[0.024023996653141495 -0.193946900394071 -0.1247290849077551 0.00044912161560128894],[0.024038380890487446 -0.0007192118672975367 -0.11968477287591933 -0.25221560159178796],0,0.000000
[0.020145058645260075 0.0027226347461993816 -0.12472010247544307 -0.32883875544104135],[0.024023996653141495 -0.193946900394071 -0.1247290849077551 0.00044912161560128894],1,0.000000
[0.02019951134018406 -0.19042356492801907 -0.1312968775842639 -0.07794256584821158],[0.020145058645260075 0.0027226347461993816 -0.12472010247544307 -0.32883875544104135],0,0.000000
[0.01639104004162368 -0.38344279374892043 -0.13285572890122813 0.17060381485878587],[0.02019951134018406 -0.19042356492801907 -0.1312968775842639 -0.07794256584821158],0,0.000000
[0.008722184166645271 -0.576437710295038 -0.1294436526040524 0.4186003006702972],[0.01639104004162368 -0.38344279374892043 -0.13285572890122813 0.17060381485878587],0,0.000000
[-0.002806570039255489 -0.3797418920474086 -0.12107164659064647 0.08807470378117449],[0.008722184166645271 -0.576437710295038 -0.1294436526040524 0.4186003006702972],1,0.000000
[-0.010401407880203661 -0.18311129853464844 -0.11931015251502297 -0.24022028371536763],[-0.002806570039255489 -0.3797418920474086 -0.12107164659064647 0.08807470378117449],1,0.000000
[-0.01406363385089663 0.01349503075254857 -0.12411455818933033 -0.5680272849165636],[-0.010401407880203661 -0.18311129853464844 -0.11931015251502297 -0.24022028371536763],1,0.000000
[-0.013793733235845658 -0.1796874983432938 -0.1354751038876616 -0.316878595266875],[-0.01406363385089663 0.01349503075254857 -0.12411455818933033 -0.5680272849165636],0,0.000000
[-0.017387483202711534 -0.3726459050308365 -0.1418126757929991 -0.0698009790642875],[-0.013793733235845658 -0.1796874983432938 -0.1354751038876616 -0.316878595266875],0,0.000000
[-0.024840401303328263 -0.5654800219333872 -0.14320869537428485 0.17499320558125034],[-0.017387483202711534 -0.3726459050308365 -0.1418126757929991 -0.0698009790642875],0,0.000000
[-0.03615000174199601 -0.7582930106062511 -0.13970883126265984 0.4192924020435286],[-0.024840401303328263 -0.5654800219333872 -0.14320869537428485 0.17499320558125034],0,0.000000
[-0.05131586195412103 -0.5614965237187353 -0.13132298322178926 0.08603296862116733],[-0.03615000174199601 -0.7582930106062511 -0.13970883126265984 0.4192924020435286],1,0.000000
[-0.06254579242849573 -0.754515465258077 -0.1296023238493659 0.3345703234968477],[-0.05131586195412103 -0.5614965237187353 -0.13132298322178926 0.08603296862116733],0,0.000000
[-0.07763610173365727 -0.5578100909645693 -0.12291091737942896 0.003990300833235039],[-0.06254579242849573 -0.754515465258077 -0.1296023238493659 0.3345703234968477],1,0.000000
[-0.08879230355294866 -0.7509745707980308 -0.12283111136276426 0.2555062651880092],[-0.07763610173365727 -0.5578100909645693 -0.12291091737942896 0.003990300833235039],0,0.000000
[-0.10381179496890927 -0.9441482268075667 -0.11772098605900408 0.5070620102494399],[-0.08879230355294866 -0.7509745707980308 -0.12283111136276426 0.2555062651880092],0,0.000000
[-0.1226947595050606 -0.7475814031194464 -0.10757974585401528 0.1797223812062333],[-0.10381179496890927 -0.9441482268075667 -0.11772098605900408 0.5070620102494399],1,0.000000
[-0.13764638756744954 -0.9410125901924725 -0.10398529822989061 0.43662431541352453],[-0.1226947595050606 -0.7475814031194464 -0.10757974585401528 0.1797223812062333],0,0.000000
[-0.15646663937129898 -0.744584223119054 -0.09525281192162012 0.1130566938709145],[-0.13764638756744954 -0.9410125901924725 -0.10398529822989061 0.43662431541352453],1,0.000000
[-0.17135832383368005 -0.9382213790854439 -0.09299167804420183 0.374233758856031],[-0.15646663937129898 -0.744584223119054 -0.09525281192162012 0.1130566938709145],0,0.000000
[-0.19012275141538892 -0.7419100103231416 -0.08550700286708121 0.053738815902300674],[-0.17135832383368005 -0.9382213790854439 -0.09299167804420183 0.374233758856031],1,0.000000
[-0.20496095162185177 -0.5456727009644778 -0.08443222654903519 -0.26465015574734974],[-0.19012275141538892 -0.7419100103231416 -0.08550700286708121 0.053738815902300674],1,0.000000
[-0.21587440564114133 -0.7394944183874608 -0.08972522966398219 0.00025315655223778766],[-0.20496095162185177 -0.5456727009644778 -0.08443222654903519 -0.26465015574734974],0,0.000000
[-0.23066429400889055 -0.9332226602225281 -0.08972016653293743 0.2633327430226586],[-0.21587440564114133 -0.7394944183874608 -0.08972522966398219 0.00025315655223778766],0,0.000000
[-0.2493287472133411 -1.1269570443821424 -0.08445351167248426 0.5264231203274041],[-0.23066429400889055 -0.9332226602225281 -0.08972016653293743 0.2633327430226586],0,0.000000
[-0.27186788810098395 -0.9307546144504952 -0.07392504926593618 0.2083685692613006],[-0.2493287472133411 -1.1269570443821424 -0.08445351167248426 0.5264231203274041],1,0.000000
[-0.2904829803899939 -0.7346577275548545 -0.06975767788071018 -0.10668756192820428],[-0.27186788810098395 -0.9307546144504952 -0.07392504926593618 0.2083685692613006],1,0.000000
[-0.30517613494109097 -0.9287142844168937 -0.07189142911927426 0.1631972033763477],[-0.2904829803899939 -0.7346577275548545 -0.06975767788071018 -0.10668756192820428],0,0.000000
[-0.3237504206294288 -1.1227373744001792 -0.06862748505174732 0.43236219545231397],[-0.30517613494109097 -0.9287142844168937 -0.07189142911927426 0.1631972033763477],0,0.000000
[-0.3462051681174324 -0.9267142447019544 -0.059980241142701035 0.1188589947535944],[-0.3237504206294288 -1.1227373744001792 -0.06862748505174732 0.43236219545231397],1,0.000000
[-0.3647394530114715 -0.7307864913310347 -0.05760306124762915 -0.19212775645332908],[-0.3462051681174324 -0.9267142447019544 -0.059980241142701035 0.1188589947535944],1,0.000000
[-0.37935518283809216 -0.9250391196539686 -0.06144561637669573 0.08184196958355061],[-0.3647394530114715 -0.7307864913310347 -0.05760306124762915 -0.19212775645332908],0,0.000000
[-0.39785596523117156 -1.119228888954705 -0.05980877698502472 0.35452326886881325],[-0.37935518283809216 -0.9250391196539686 -0.06144561637669573 0.08184196958355061],0,0.000000
[-0.42024054301026564 -1.3134516933091709 -0.052718311607648456 0.6277632672151037],[-0.39785596523117156 -1.119228888954705 -0.05980877698502472 0.35452326886881325],0,0.000000
[-0.44650957687644904 -1.1176351277936387 -0.04016304626334638 0.31895448212561334],[-0.42024054301026564 -1.3134516933091709 -0.052718311607648456 0.6277632672151037],1,0.000000
[-0.46886227943232184 -0.9219648665243303 -0.03378395662083411 0.013881019463202415],[-0.44650957687644904 -1.1176351277936387 -0.04016304626334638 0.31895448212561334],1,0.000000
[-0.48730157676280844 -1.1165864338875695 -0.03350633623157006 0.29571619308488944],[-0.46886227943232184 -0.9219648665243303 -0.03378395662083411 0.013881019463202415],0,0.000000
[-0.5096333054405598 -1.311215090685718 -0.02759201236987227 0.5776462953943649],[-0.48730157676280844 -1.1165864338875695 -0.03350633623157006 0.29571619308488944],0,0.000000
[-0.5358576072542742 -1.115717499196972 -0.016039086461984972 0.27640050575819536],[-0.5096333054405598 -1.311215090685718 -0.02759201236987227 0.5776462953943649],1,0.000000
[-0.5581719572382137 -1.310606993140131 -0.010511076346821066 0.5639818564079739],[-0.5358576072542742 -1.115717499196972 -0.016039086461984972 0.27640050575819536],0,0.000000
[-0.5843840971010162 -1.1153391490254672 0.0007685607813384121 0.2680060708368386],[-0.5581719572382137 -1.310606993140131 -0.010511076346821066 0.5639818564079739],1,0.000000
[-0.6066908800815256 -1.3104720602359716 0.006128682198075184 0.5609313080534069],[-0.5843840971010162 -1.1153391490254672 0.0007685607813384121 0.2680060708368386],0,0.000000
[-0.6329003212862451 -1.115436655797488 0.01734730835914332 0.2701855169214337],[-0.6066908800815256 -1.3104720602359716 0.006128682198075184 0.5609313080534069],1,0.000000
[-0.6552090544021948 -0.9205664955046211 0.022751018697571998 -0.01697589017702089],[-0.6329003212862451 -1.115436655797488 0.01734730835914332 0.2701855169214337],1,0.000000
[-0.6736203843122872 -1.1160072098417757 0.02241150089403158 0.2827975357002075],[-0.6552090544021948 -0.9205664955046211 0.022751018697571998 -0.01697589017702089],0,0.000000
[-0.6959405285091227 -1.311441537309672 0.02806745160803573 0.582463838292517],[-0.6736203843122872 -1.1160072098417757 0.02241150089403158 0.2827975357002075],0,0.000000
[-0.7221693592553161 -1.1167238353243296 0.03971672837388607 0.2987530714392483],[-0.6959405285091227 -1.311441537309672 0.02806745160803573 0.582463838292517],1,0.000000
[-0.7445038359618027 -0.9221898652983695 0.04569178980267104 0.01885588080189926],[-0.7221693592553161 -1.1167238353243296 0.03971672837388607 0.2987530714392483],1,0.000000
[-0.76294763326777 -1.1179362944384912 0.046068907418709025 0.32559778960033314],[-0.7445038359618027 -0.9221898652983695 0.04569178980267104 0.01885588080189926],0,0.000000
[-0.7853063591565399 -0.9234995146198388 0.052580863210715686 0.04779152983106211],[-0.76294763326777 -1.1179362944384912 0.046068907418709025 0.32559778960033314],1,0.000000
[-0.8037763494489367 -1.1193344654806123 0.05353669380733693 0.3565896255778434],[-0.7853063591565399 -0.9234995146198388 0.052580863210715686 0.04779152983106211],0,0.000000
[-0.826163038758549 -0.9250129184907615 0.0606684863188938 0.08125719559635902],[-0.8037763494489367 -1.1193344654806123 0.05353669380733693 0.3565896255778434],1,0.000000`
  .split("\n")

type AppState = {
  keyframes: Result<Keyframe[]>
  currentFrame: number
  isPlaying: boolean
  fps: number
}

export default class App extends Component<{}, AppState> {
  public state: AppState = {
    keyframes: KeyframesFromLines(INPUT),
    currentFrame: 0,
    isPlaying: true,
    fps: 25
  }

  onTimeout() {
    setTimeout(() => {
      if (this.state.isPlaying && !(this.state.keyframes instanceof Error)) {
        this.setState({ currentFrame: (this.state.currentFrame + 1) % (this.state.keyframes.length - 1) })
        this.onTimeout()
      }
    }, 1000 / this.state.fps)
  }

  componentDidMount() {
    this.onTimeout()
  }

  render() {
    let kfComponent;
    let vizComponent;
    if (this.state.keyframes instanceof Error) {
      return (<div>Error: {this.state.keyframes} </div>)
    } else {
      return (
        /* Menu */
        <div className="container flex-direction=row">
          <div className="terminal-nav">
            <header className="terminal-logo">Bigtop</header>
            <nav className="terminal-menu">
              <ul vocab="https://schema.org" typeof="BreadcrumbList">
                <li><a href="#">About</a></li>
                <li><a href="#">Upload</a></li>
              </ul>
            </nav>
          </div>
          <hr />
          <div className="container flex flex-direction=column">
            {/* left column: the viz stage */}
            <div className="">
              <CartpoleStage kf={this.state.keyframes[this.state.currentFrame]} />
              {vizComponent}
            </div>
            {/* right column: the keyframe table and controls */}
            <div className="container flex-direction=row">
              <div className="container keyframe-table">
                <KeyframeTable currentFrame={this.state.currentFrame} keyframes={this.state.keyframes} />
              </div>
              <div className="container">
                <PlaybackControls
                  isPlaying={this.state.isPlaying}
                  fps={this.state.fps}
                  currentFrame={this.state.currentFrame}
                  totalFrames={this.state.keyframes.length}
                  onFPSChange={(fps: number) => this.setState({ fps: fps })}
                  onFrameChange={(frame: number) => {
                    this.setState({ currentFrame: frame, isPlaying: false })
                  }}
                  onPauseClick={() => {
                    this.setState({ isPlaying: !this.state.isPlaying })
                    this.onTimeout()
                  }} />
              </div>
            </div>
          </div>
        </div >
      );
    }
  }
};
